<!DOCTYPE html>
<html>
<head>
    <title>Mario Car Obby - Level 3</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; }
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 2px 2px black;
            pointer-events: none;
        }
        #gas-container { width: 150px; height: 20px; border: 2px solid white; margin-top: 5px; }
        #gas-bar { width: 100%; height: 100%; background-color: #00ff00; }
    </style>
</head>
<body>

    <div id="hud">
        <div style="font-size: 24px;">Time: <span id="time-val">0.00</span></div>
        <div style="font-size: 18px;">Level: 3</div>
        <div id="gas-container"><div id="gas-bar"></div></div>
        <div style="font-size: 12px;">E [---------] FULL</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 7.5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // Track
        const ground = new THREE.Mesh(new THREE.BoxGeometry(20, 1, 500), new THREE.MeshLambertMaterial({ color: 0x228b22 }));
        ground.position.y = -1;
        scene.add(ground);

        // Car
        const carGroup = new THREE.Group();
        carGroup.add(new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.7, 3), new THREE.MeshLambertMaterial({ color: 0xff0000 })));
        carGroup.add(new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.5, 1.5), new THREE.MeshLambertMaterial({ color: 0xffffff }))).position.y = 0.6;
        scene.add(carGroup);

        // Obstacles & Gas Cans Arrays
        const obstacles = [];
        const gasCans = [];

        function createLevel() {
            for (let i = 1; i < 20; i++) {
                // Create Green Pipe
                const pipe = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 3), new THREE.MeshLambertMaterial({ color: 0x00ff00 }));
                pipe.position.set(Math.random() * 10 - 5, 0.5, -i * 20);
                scene.add(pipe);
                obstacles.push(pipe);

                // Create Gas Can
                const can = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1, 0.5), new THREE.MeshLambertMaterial({ color: 0xffffff }));
                can.position.set(Math.random() * 10 - 5, 0, -i * 25 - 10);
                scene.add(can);
                gasCans.push(can);
            }
        }
        createLevel();

        let velocityY = 0, isGrounded = true, gas = 100, time = 0, keys = {};

        window.addEventListener('keydown', (e) => { 
            keys[e.code] = true; 
            if (e.code === 'Space' && isGrounded) { velocityY = 0.2; isGrounded = false; }
        });
        window.addEventListener('keyup', (e) => { keys[e.code] = false; });

        function animate() {
            requestAnimationFrame(animate);

            if (gas > 0) {
                if (keys['ArrowUp']) { carGroup.position.z -= 0.3; gas -= 0.05; }
                if (keys['ArrowDown']) { carGroup.position.z += 0.2; gas -= 0.02; }
                if (keys['ArrowLeft']) carGroup.position.x -= 0.15;
                if (keys['ArrowRight']) carGroup.position.x += 0.15;
            }

            // Jump Physics
            carGroup.position.y += velocityY;
            if (carGroup.position.y > 0) { velocityY -= 0.01; } 
            else { carGroup.position.y = 0; velocityY = 0; isGrounded = true; }

            // Collision Detection for Gas Cans
            gasCans.forEach((can, index) => {
                if (carGroup.position.distanceTo(can.position) < 2) {
                    gas = 100; // Refill!
                    scene.remove(can);
                    gasCans.splice(index, 1);
                }
            });

            // Collision Detection for Pipes
            obstacles.forEach(pipe => {
                if (carGroup.position.distanceTo(pipe.position) < 2 && carGroup.position.y < 1) {
                    carGroup.position.z += 0.5; // Bump back
                }
            });

            // HUD
            document.getElementById('gas-bar').style.width = gas + "%";
            time += 0.01;
            document.getElementById('time-val').innerText = time.toFixed(2);

            camera.position.set(carGroup.position.x, carGroup.position.y + 6, carGroup.position.z + 12);
            camera.lookAt(carGroup.position);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
